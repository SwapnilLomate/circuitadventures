@page "/"
@inject UserService UserService
@inject NavigationManager Navigation
@inject ProgressService ProgressService

@if (isLoading)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else if (!isOnboarded)
{
    @* Redirect to onboarding *@
    <p>Redirecting to onboarding...</p>
}
else
{
    <div class="home-page">
        <MudGrid>
            <MudItem xs="12">
                <MudPaper Elevation="2" Class="pa-4">
                    <div class="welcome-header">
                        <MudText Typo="Typo.h3" Color="Color.Primary">
                            @(UserService.CurrentUser?.Avatar ?? "üëã") Welcome back, @UserService.CurrentUser?.Name!
                        </MudText>
                        <MudText Typo="Typo.body1" Class="mt-2">
                            Ready to continue your electronics journey?
                        </MudText>
                    </div>
                </MudPaper>
            </MudItem>

            @* Continue Learning Button *@
            <MudItem xs="12" md="6">
                <MudPaper Elevation="3" Class="pa-4 continue-learning-card">
                    <MudText Typo="Typo.h5" Class="mb-2">üöÄ Continue Learning</MudText>
                    <MudText Typo="Typo.body1" Class="mb-3">
                        You're on Level @currentLevel
                    </MudText>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               Size="Size.Large"
                               FullWidth="true"
                               OnClick="ContinueLearning">
                        Go to Level @currentLevel ‚Üí
                    </MudButton>
                </MudPaper>
            </MudItem>

            @* Quick Stats *@
            <MudItem xs="12" md="6">
                <MudPaper Elevation="2" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-3">üìä Your Progress</MudText>
                    <MudStack Spacing="2">
                        <div class="stat-item">
                            <MudText Typo="Typo.body1">Levels Completed: <strong>@completedLevels / 100</strong></MudText>
                            <MudProgressLinear Color="Color.Success" Value="@completionPercentage" Class="my-2" />
                        </div>
                        <MudText Typo="Typo.body1">
                            ‚≠ê Total Stars: <strong>@totalStars</strong>
                        </MudText>
                        <MudText Typo="Typo.body1">
                            üî• Current Streak: <strong>@currentStreak days</strong>
                        </MudText>
                    </MudStack>
                </MudPaper>
            </MudItem>

            @* Next Certificate Milestone *@
            <MudItem xs="12" md="6">
                <MudPaper Elevation="2" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-3">üèÜ Next Certificate</MudText>
                    <MudText Typo="Typo.body1" Class="mb-2">
                        Complete @nextCertificateLevels more levels to earn:
                    </MudText>
                    <MudText Typo="Typo.h6" Color="Color.Secondary">
                        @nextCertificateName
                    </MudText>
                    <MudProgressLinear Color="Color.Warning" Value="@certificateProgress" Class="my-2" />
                </MudPaper>
            </MudItem>

            @* Safety Reminder *@
            <MudItem xs="12" md="6">
                <MudAlert Severity="Severity.Info" Icon="@Icons.Material.Filled.Warning">
                    <MudText Typo="Typo.body1"><strong>Safety First!</strong></MudText>
                    <MudText Typo="Typo.body2">Always ask an adult for help when working with electronics.</MudText>
                </MudAlert>
            </MudItem>
        </MudGrid>
    </div>
}

@code {
    private bool isLoading = true;
    private bool isOnboarded = false;
    private int currentLevel = 1;
    private int completedLevels = 0;
    private int totalStars = 0;
    private int currentStreak = 0;
    private double completionPercentage = 0;
    private int nextCertificateLevels = 10;
    private string nextCertificateName = "Spark Starter Certificate";
    private double certificateProgress = 0;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;

        // Check if user is onboarded
        isOnboarded = await UserService.IsUserOnboardedAsync();

        if (!isOnboarded)
        {
            // Redirect to onboarding
            Navigation.NavigateTo("/onboarding");
            return;
        }

        // Load user data
        var user = UserService.CurrentUser;
        if (user != null)
        {
            currentLevel = user.CurrentLevel;
            completedLevels = user.CompletedLevels.Count;
            totalStars = ProgressService.GetTotalStars();
            currentStreak = user.Streak.Current;
            completionPercentage = ProgressService.GetCompletionPercentage();

            // Calculate next certificate
            int nextMilestone = ((currentLevel / 10) + 1) * 10;
            if (nextMilestone > 100) nextMilestone = 100;
            nextCertificateLevels = nextMilestone - completedLevels;
            certificateProgress = ((double)completedLevels % 10) / 10.0 * 100;

            nextCertificateName = nextMilestone switch
            {
                10 => "Spark Starter Certificate",
                20 => "Current Explorer Certificate",
                30 => "Circuit Apprentice Certificate",
                40 => "Voltage Voyager Certificate",
                50 => "Motion Magician Certificate",
                60 => "Light Illuminator Certificate",
                70 => "Power Pioneer Certificate",
                80 => "Innovation Inventor Certificate",
                90 => "Circuit Champion Certificate",
                100 => "Master Electrician Certificate",
                _ => "Certificate"
            };
        }

        isLoading = false;
    }

    private void ContinueLearning()
    {
        Navigation.NavigateTo($"/level/{currentLevel}");
    }
}
