@page "/certificates"
@inject UserService UserService
@inject CertificateService CertificateService
@inject NavigationManager Navigation
@inject IDialogService DialogService

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h3" Color="Color.Primary" Class="mb-2">
        üèÜ Certificates
    </MudText>
    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
        Celebrate your milestones! Earn certificates by completing every 10th level.
    </MudText>

    @if (user != null)
    {
        @if (user.Certificates.Any())
        {
            <MudGrid>
                @foreach (var cert in user.Certificates.OrderBy(c => c.Level))
                {
                    var design = CertificateService.GetCertificateDesign(cert.Level);
                    <MudItem xs="12" sm="6" md="4">
                        <MudCard Elevation="4" Style="@GetCertificateCardStyle(design)" Class="hover-card">
                            <MudCardContent Style="text-align: center;">
                                <div style="font-size: 64px; margin-bottom: 16px;">@(design?.IconSymbol ?? "üèÜ")</div>
                                <MudText Typo="Typo.h5" Class="mb-2">@(design?.Name ?? "Certificate")</MudText>
                                <MudDivider Class="my-2" />
                                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                                    Level @cert.Level Milestone
                                </MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @(design?.Description ?? "For completing CircuitAdventures")
                                </MudText>
                                <MudText Typo="Typo.body2" Class="mt-3" Style="font-style: italic;">
                                    Earned: @cert.EarnedDate.ToString("MMMM dd, yyyy")
                                </MudText>
                            </MudCardContent>
                            <MudCardActions Style="justify-content: center;">
                                <MudButton Variant="Variant.Filled"
                                         Color="Color.Primary"
                                         StartIcon="@Icons.Material.Filled.Visibility"
                                         OnClick="@(() => ViewCertificate(cert))">
                                    View Certificate
                                </MudButton>
                            </MudCardActions>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>

            @* Certificate Milestones Progress *@
            <MudPaper Elevation="2" Class="pa-4 mt-6">
                <MudText Typo="Typo.h6" Class="mb-3">Certificate Collection Progress</MudText>
                <MudGrid>
                    @foreach (var milestone in new[] { 10, 20, 30, 40, 50, 60, 70, 80, 90, 100 })
                    {
                        var hasCert = user.Certificates.Any(c => c.Level == milestone);
                        var isUnlocked = user.CurrentLevel >= milestone;
                        <MudItem xs="6" sm="4" md="2">
                            <MudPaper Elevation="1"
                                     Class="pa-3"
                                     Style="@GetMilestoneStyle(hasCert, isUnlocked)">
                                <div style="text-align: center;">
                                    <div style="font-size: 32px; margin-bottom: 8px;">
                                        @if (hasCert)
                                        {
                                            <text>‚úÖ</text>
                                        }
                                        else if (isUnlocked)
                                        {
                                            <text>üîì</text>
                                        }
                                        else
                                        {
                                            <text>üîí</text>
                                        }
                                    </div>
                                    <MudText Typo="Typo.body2" Style="font-weight: bold;">
                                        Level @milestone
                                    </MudText>
                                </div>
                            </MudPaper>
                        </MudItem>
                    }
                </MudGrid>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-3">
                    Earned: @user.Certificates.Count / 10 certificates
                </MudText>
            </MudPaper>
        }
        else
        {
            <MudPaper Elevation="2" Class="pa-6" Style="text-align: center;">
                <div style="font-size: 80px; margin-bottom: 20px;">üéØ</div>
                <MudText Typo="Typo.h5" Class="mb-3">No Certificates Yet</MudText>
                <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
                    Complete your first milestone level (Level 10) to earn your first certificate!
                </MudText>
                <MudButton Variant="Variant.Filled"
                          Color="Color.Primary"
                          StartIcon="@Icons.Material.Filled.Map"
                          Href="/levels">
                    Start Your Journey
                </MudButton>
            </MudPaper>
        }
    }
    else
    {
        <MudPaper Elevation="2" Class="pa-6" Style="text-align: center;">
            <MudText Typo="Typo.h6">Loading...</MudText>
        </MudPaper>
    }
</MudContainer>

<style>
    .hover-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .hover-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }
</style>

@code {
    private Models.UserData? user;

    protected override async Task OnInitializedAsync()
    {
        // Check if user is onboarded
        var isOnboarded = await UserService.IsUserOnboardedAsync();
        if (!isOnboarded)
        {
            Navigation.NavigateTo("/onboarding");
            return;
        }

        user = UserService.CurrentUser;
    }

    private string GetCertificateCardStyle(Models.CertificateDesign? design)
    {
        if (design == null) return "background: linear-gradient(135deg, #EFF6FF 0%, white 100%);";
        return $"background: linear-gradient(135deg, {design.BackgroundColor} 0%, white 100%); border-top: 4px solid {design.BorderColor};";
    }

    private string GetMilestoneStyle(bool hasCert, bool isUnlocked)
    {
        if (hasCert)
            return "background-color: #e8f5e9; border: 2px solid #4caf50;";
        else if (isUnlocked)
            return "background-color: #fff3e0; border: 2px solid #ff9800;";
        else
            return "background-color: #f5f5f5; border: 2px solid #9e9e9e; opacity: 0.6;";
    }

    private async Task ViewCertificate(Models.Certificate cert)
    {
        if (user == null) return;

        var parameters = new DialogParameters<Components.CertificateModal>
        {
            { x => x.Certificate, cert },
            { x => x.UserName, user.Name },
            { x => x.MilestoneLevel, cert.Level }
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        await DialogService.ShowAsync<Components.CertificateModal>("", parameters, options);
    }
}
